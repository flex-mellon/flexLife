<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <title>Продуктивность</title>
    <style>
        body {
            font-family: sans-serif;
            margin: 0; padding: 0;
            background: #f7f7f7;
            display: flex; flex-direction: column;
            height: 100vh;
        }
        main { flex: 1; overflow-y: auto; padding: 10px; }
        .counter-container {
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 20px;
            margin: 20px 0;
        }
        .counter {
            font-size: 40px;
            font-weight: bold;
        }
        .level-ring {
            position: relative;
            width: 80px;
            height: 80px;
        }
        .level-ring svg {
            transform: rotate(-90deg);
        }
        .level-ring circle {
            fill: none;
            stroke-width: 8;
            r: 36;
            cx: 40;
            cy: 40;
        }
        .level-ring .bg {
            stroke: #eee;
        }
        .level-ring .progress {
            stroke: #4caf50;
            stroke-linecap: round;
        }
        .level-text {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%,-50%);
            font-size: 18px;
            font-weight: bold;
        }
        .chips {
            display: flex;
            gap: 8px;
            flex-wrap: wrap;
            justify-content: center;
            margin-bottom: 15px;
        }
        .chip {
            padding: 8px 16px;
            border-radius: 20px;
            background: #ddd;
            cursor: pointer;
            user-select: none;
        }
        .chip:hover { background: #ccc; }
        .chip.add { background: #4caf50; color: white; font-weight: bold; }
        .keyboard-container {
            display: none;
            margin: 10px auto;
            max-width: 300px;
        }
        .input-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 8px;
        }
        .input-display {
            flex: 1;
            background: #fff;
            border: 1px solid #ccc;
            padding: 15px;
            font-size: 20px;
            text-align: left;
            border-radius: 10px;
            margin-right: 8px;
        }
        .confirm-btn {
            background: #4caf50;
            color: white;
            padding: 15px;
            border-radius: 10px;
            font-size: 20px;
            cursor: pointer;
        }
        .keyboard {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 8px;
        }
        .key {
            background: #fff;
            border: 1px solid #ccc;
            padding: 15px;
            font-size: 20px;
            text-align: center;
            cursor: pointer;
            border-radius: 10px;
        }
        .history, .category-list {
            list-style: none;
            padding: 0;
        }
        .history li, .category-list li {
            background: #fff;
            margin: 5px 0;
            padding: 10px;
            border-radius: 6px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .record-actions button,
        .cat-actions button {
            margin-left: 5px;
        }
        nav {
            display: flex;
            border-top: 1px solid #ccc;
        }
        nav button {
            flex: 1;
            padding: 12px;
            font-size: 16px;
            border: none;
            background: #eee;
            cursor: pointer;
        }
        nav button.active { background: #ccc; }
        .history-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
    </style>
</head>
<body>

<main>
    <!-- Главная -->
    <div id="screen-main">
        <div class="counter-container">
            <div class="counter" id="counter">0</div>
            <div class="level-ring">
                <svg width="80" height="80">
                    <circle class="bg" r="36" cx="40" cy="40"></circle>
                    <circle class="progress" r="36" cx="40" cy="40" stroke-dasharray="226" stroke-dashoffset="226"></circle>
                </svg>
                <div class="level-text" id="levelText">0</div>
            </div>
        </div>
        <div class="chips" id="categories">
            <div class="chip add" onclick="addCategoryPrompt()">+</div>
        </div>
        <div class="keyboard-container" id="keyboardContainer">
            <div class="input-row">
                <div class="input-display" id="inputDisplay"></div>
                <div class="confirm-btn" id="confirmBtn">✓</div>
            </div>
            <div class="keyboard" id="keyboard"></div>
        </div>
    </div>

    <!-- История -->
    <div id="screen-history" style="display:none;">
        <div class="history-header">
            <h3>История</h3>
            <select id="sortSelect">
                <option value="desc">Сначала новые</option>
                <option value="asc">Сначала старые</option>
            </select>
        </div>
        <ul class="history" id="historyList"></ul>
    </div>

    <!-- Категории -->
    <div id="screen-categories" style="display:none;">
        <h3>Категории</h3>
        <button onclick="addCategoryPrompt()">+ Добавить категорию</button>
        <ul class="category-list" id="categoryList"></ul>
    </div>
</main>

<nav>
    <button id="btn-main" class="active">Главная</button>
    <button id="btn-history">История</button>
    <button id="btn-categories">Категории</button>
</nav>

<script>
    let db;
    const request = indexedDB.open("productivityDB", 9);
    request.onupgradeneeded = (e) => {
        db = e.target.result;
        if (!db.objectStoreNames.contains("records")) {
            db.createObjectStore("records", { keyPath: "id", autoIncrement: true });
        }
        if (!db.objectStoreNames.contains("categories")) {
            db.createObjectStore("categories", { keyPath: "id", autoIncrement: true });
        }
    };
    request.onsuccess = (e) => {
        db = e.target.result;
        loadHistory();
        loadCategories();
        updateCounter();
    };

    const counterEl = document.getElementById("counter");
    const keyboardEl = document.getElementById("keyboard");
    const keyboardContainer = document.getElementById("keyboardContainer");
    const historyEl = document.getElementById("historyList");
    const categoriesEl = document.getElementById("categories");
    const categoryListEl = document.getElementById("categoryList");
    const inputDisplay = document.getElementById("inputDisplay");
    const confirmBtn = document.getElementById("confirmBtn");
    const progressCircle = document.querySelector(".progress");
    const levelText = document.getElementById("levelText");
    const sortSelect = document.getElementById("sortSelect");

    const circleLength = 2 * Math.PI * 36;
    progressCircle.setAttribute("stroke-dasharray", circleLength);

    let currentCategoryId = null;
    let currentValue = "";

    // Загружаем сортировку
    let sortOrder = localStorage.getItem("historySort") || "desc";
    sortSelect.value = sortOrder;
    sortSelect.onchange = () => {
        sortOrder = sortSelect.value;
        localStorage.setItem("historySort", sortOrder);
        loadHistory();
    };

    // ===== Категории =====
    function addCategory(name) {
        const tx = db.transaction("categories", "readwrite");
        tx.objectStore("categories").add({ name });
        tx.oncomplete = () => loadCategories();
    }
    function updateCategory(id, newName) {
        const tx = db.transaction("categories", "readwrite");
        const store = tx.objectStore("categories");
        store.get(id).onsuccess = (e) => {
            const cat = e.target.result;
            cat.name = newName;
            store.put(cat);
        };
        tx.oncomplete = () => { loadCategories(); loadHistory(); };
    }
    function deleteCategory(id) {
        const tx = db.transaction("categories", "readwrite");
        tx.objectStore("categories").delete(id);
        tx.oncomplete = () => { loadCategories(); loadHistory(); };
    }
    function loadCategories() {
        categoriesEl.innerHTML = "";
        const addChip = document.createElement("div");
        addChip.className = "chip add";
        addChip.textContent = "+";
        addChip.onclick = addCategoryPrompt;
        categoriesEl.appendChild(addChip);

        categoryListEl.innerHTML = "";
        const tx = db.transaction("categories", "readonly");
        tx.objectStore("categories").openCursor().onsuccess = (e) => {
            const cursor = e.target.result;
            if (cursor) {
                const cat = cursor.value;
                const chip = document.createElement("div");
                chip.className = "chip";
                chip.textContent = cat.name;
                chip.onclick = () => { currentCategoryId = cat.id; showKeyboard(); };
                categoriesEl.appendChild(chip);

                const li = document.createElement("li");
                li.innerHTML = `<span>${cat.name}</span>`;
                const actions = document.createElement("div");
                actions.className = "cat-actions";
                const editBtn = document.createElement("button");
                editBtn.textContent = "✎";
                editBtn.onclick = () => {
                    const newName = prompt("Новое название:", cat.name);
                    if (newName) updateCategory(cat.id, newName);
                };
                const delBtn = document.createElement("button");
                delBtn.textContent = "🗑";
                delBtn.onclick = () => deleteCategory(cat.id);
                actions.appendChild(editBtn);
                actions.appendChild(delBtn);
                li.appendChild(actions);
                categoryListEl.appendChild(li);

                cursor.continue();
            }
        };
    }
    function addCategoryPrompt() {
        const name = prompt("Название категории:");
        if (name) addCategory(name);
    }

    // ===== Клавиатура =====
    function showKeyboard() {
        keyboardEl.innerHTML = "";
        keyboardContainer.style.display = "block";
        inputDisplay.textContent = "";
        const keys = ["1","2","3","4","5","6","7","8","9","0","-","←"];
        keys.forEach(k => {
            const btn = document.createElement("div");
            btn.className = "key";
            btn.textContent = k;
            btn.onclick = () => handleKey(k);
            keyboardEl.appendChild(btn);
        });
        currentValue = "";
    }
    function handleKey(k) {
        if (k === "←") {
            currentValue = currentValue.slice(0,-1);
        } else {
            if (k === "-" && currentValue.includes("-")) return;
            currentValue += k;
        }
        inputDisplay.textContent = currentValue;
    }
    confirmBtn.onclick = () => {
        if (currentValue) saveRecord(currentCategoryId, parseInt(currentValue));
        keyboardContainer.style.display = "none";
        inputDisplay.textContent = "";
    };

    // ===== Записи =====
    function saveRecord(categoryId, value) {
        const tx = db.transaction("records", "readwrite");
        tx.objectStore("records").add({ categoryId, value, date: new Date().toISOString() });
        tx.oncomplete = () => { loadHistory(); updateCounter(); };
    }
    function updateRecord(id, newValue) {
        const tx = db.transaction("records", "readwrite");
        const store = tx.objectStore("records");
        store.get(id).onsuccess = (e) => {
            const rec = e.target.result;
            rec.value = newValue;
            store.put(rec);
        };
        tx.oncomplete = () => { loadHistory(); updateCounter(); };
    }
    function deleteRecord(id) {
        const tx = db.transaction("records", "readwrite");
        tx.objectStore("records").delete(id);
        tx.oncomplete = () => { loadHistory(); updateCounter(); };
    }
    function loadHistory() {
        historyEl.innerHTML = "";
        const records = [];
        const categoriesMap = {};
        const txCats = db.transaction("categories", "readonly");
        txCats.objectStore("categories").openCursor().onsuccess = (e) => {
            const cursor = e.target.result;
            if (cursor) {
                categoriesMap[cursor.value.id] = cursor.value.name;
                cursor.continue();
            }
        };
        txCats.oncomplete = () => {
            const tx = db.transaction("records", "readonly");
            tx.objectStore("records").openCursor().onsuccess = (e) => {
                const cursor = e.target.result;
                if (cursor) {
                    records.push(cursor.value);
                    cursor.continue();
                } else {
                    records.sort((a,b) => {
                        if (sortOrder === "asc") return new Date(a.date) - new Date(b.date);
                        else return new Date(b.date) - new Date(a.date);
                    });
                    records.forEach(rec => {
                        const li = document.createElement("li");
                        const catName = categoriesMap[rec.categoryId] || "❌ Удалено";
                        const textSpan = document.createElement("span");
                        textSpan.textContent = `${catName}: ${rec.value}`;

                        const actions = document.createElement("div");
                        actions.className = "record-actions";

                        const editBtn = document.createElement("button");
                        editBtn.textContent = "✎";
                        editBtn.onclick = () => {
                            const newVal = prompt("Новое значение:", rec.value);
                            if (newVal !== null && newVal.trim() !== "" && !isNaN(newVal)) {
                                updateRecord(rec.id, parseInt(newVal));
                            }
                        };
                        const delBtn = document.createElement("button");
                        delBtn.textContent = "🗑";
                        delBtn.onclick = () => deleteRecord(rec.id);

                        actions.appendChild(editBtn);
                        actions.appendChild(delBtn);

                        li.appendChild(textSpan);
                        li.appendChild(actions);
                        historyEl.appendChild(li);
                    });
                }
            };
        };
    }

    // ===== Счётчик =====
    function updateCounter() {
        let sum = 0;
        const tx = db.transaction("records", "readonly");
        tx.objectStore("records").openCursor().onsuccess = (e) => {
            const cursor = e.target.result;
            if (cursor) {
                sum += cursor.value.value;
                cursor.continue();
            } else {
                counterEl.textContent = sum;
                if (sum > 0) counterEl.style.color = "green";
                else if (sum < 0) counterEl.style.color = "red";
                else counterEl.style.color = "black";

                let level = 0, progress = 0;
                if (sum > 0) {
                    level = Math.floor(sum / 100);
                    progress = sum % 100;
                }
                const offset = circleLength - (circleLength * progress / 100);
                progressCircle.setAttribute("stroke-dashoffset", offset);
                levelText.textContent = level;
            }
        };
    }

    // ===== Навигация =====
    function showScreen(id) {
        ["screen-main","screen-history","screen-categories"].forEach(s => {
            document.getElementById(s).style.display = "none";
        });
        document.getElementById(id).style.display = "block";

        document.querySelectorAll("nav button").forEach(b => b.classList.remove("active"));
        if (id === "screen-main") document.getElementById("btn-main").classList.add("active");
        if (id === "screen-history") document.getElementById("btn-history").classList.add("active");
        if (id === "screen-categories") document.getElementById("btn-categories").classList.add("active");
    }

    document.getElementById("btn-main").onclick = () => showScreen("screen-main");
    document.getElementById("btn-history").onclick = () => showScreen("screen-history");
    document.getElementById("btn-categories").onclick = () => showScreen("screen-categories");
</script>
</body>
</html>
