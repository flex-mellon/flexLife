<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>–ü—Ä–æ–¥—É–∫—Ç–∏–≤–Ω–æ—Å—Ç—å</title>
    <style>
        body {
            font-family: sans-serif;
            margin: 0;
            padding: 0;
            background: #f7f7f7;
            display: flex;
            flex-direction: column;
            height: 100vh;
            -webkit-tap-highlight-color: transparent;
        }
        main {
            flex: 1;
            overflow-y: auto;
            padding: 4vw;
            margin-bottom: 16vh; /* –º–µ—Å—Ç–æ –ø–æ–¥ –∫–ª–∞–≤–∏–∞—Ç—É—Ä—É –∏ –Ω–∞–≤–∏–≥–∞—Ü–∏—é */
        }

        /* –°—á—ë—Ç—á–∏–∫ –∏ —É—Ä–æ–≤–µ–Ω—å */
        .counter-container {
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 6vw;
            margin: 4vh 0;
        }
        .counter {
            font-size: 10vw;
            font-weight: bold;
        }
        .level-ring {
            position: relative;
            width: 20vw;
            height: 20vw;
            min-width: 70px;
            min-height: 70px;
        }
        .level-ring svg {
            transform: rotate(-90deg);
            width: 100%;
            height: 100%;
        }
        .level-ring circle {
            fill: none;
            stroke-width: 8;
            r: 36;
            cx: 40;
            cy: 40;
        }
        .level-ring .bg { stroke: #eee; }
        .level-ring .progress {
            stroke: #4caf50;
            stroke-linecap: round;
        }
        .level-text {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%,-50%);
            font-size: 5vw;
            font-weight: bold;
        }

        /* –ö–∞—Ç–µ–≥–æ—Ä–∏–∏ */
        .chips {
            display: flex;
            flex-wrap: wrap;
            gap: 3vw;
            justify-content: center;
            margin-bottom: 4vh;
        }
        .chip {
            padding: 1.5vh 3vw;
            border-radius: 20px;
            background: #ddd;
            cursor: pointer;
            font-size: 4vw;
            min-width: 18vw;
            text-align: center;
            user-select: none;
        }
        .chip.add { background: #4caf50; color: white; font-weight: bold; }
        .chip:active { background: #bbb; }

        /* –ö–ª–∞–≤–∏–∞—Ç—É—Ä–∞ */
        .keyboard-container {
            position: fixed;
            bottom: 8vh; /* –Ω–∞–¥ –Ω–∞–≤–∏–≥–∞—Ü–∏–µ–π */
            left: 0; right: 0;
            background: #f7f7f7;
            padding: 1vh 3vw;
            border-top: 1px solid #ccc;
            display: none;
        }
        .input-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1vh;
        }
        .input-display {
            flex: 1;
            background: #fff;
            border: 1px solid #ccc;
            padding: 1.5vh;
            font-size: 5vw;
            border-radius: 12px;
            margin-right: 2vw;
        }
        .confirm-btn {
            background: #4caf50;
            color: white;
            padding: 1.5vh 3vw;
            border-radius: 12px;
            font-size: 5vw;
            cursor: pointer;
        }
        .keyboard {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 1vw;
        }
        .key {
            background: #fff;
            border: 1px solid #ccc;
            padding: 2.5vh 0;
            font-size: 5vw;
            text-align: center;
            cursor: pointer;
            border-radius: 10px;
            user-select: none;
        }
        .key:active { background: #eee; }

        /* –ò—Å—Ç–æ—Ä–∏—è */
        .history-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 2vh;
        }
        .history, .weekly-list, .category-list {
            list-style: none;
            padding: 0;
            margin: 0;
        }
        .history li, .weekly-list li, .category-list li {
            background: #fff;
            margin: 1vh 0;
            padding: 2vh 3vw;
            border-radius: 10px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-size: 4.5vw;
        }
        .record-actions button,
        .cat-actions button {
            font-size: 5vw;
            padding: 0.5vh 1.5vw;
            margin-left: 2vw;
        }

        /* –ù–∞–≤–∏–≥–∞—Ü–∏—è */
        nav {
            display: flex;
            border-top: 1px solid #ccc;
            height: 8vh;
        }
        nav button {
            flex: 1;
            font-size: 6vw;
            border: none;
            background: #eee;
            cursor: pointer;
        }
        nav button.active { background: #ccc; }
    </style>
</head>
<body>

<main>
    <!-- –ì–ª–∞–≤–Ω–∞—è -->
    <div id="screen-main">
        <div class="counter-container">
            <div class="counter" id="counter">0</div>
            <div class="level-ring">
                <svg viewBox="0 0 80 80">
                    <circle class="bg" r="36" cx="40" cy="40"></circle>
                    <circle class="progress" r="36" cx="40" cy="40" stroke-dasharray="226" stroke-dashoffset="226"></circle>
                </svg>
                <div class="level-text" id="levelText">0</div>
            </div>
        </div>
        <div class="chips" id="categories">
            <div class="chip add" onclick="addCategoryPrompt()">+</div>
        </div>
    </div>

    <!-- –ò—Å—Ç–æ—Ä–∏—è -->
    <div id="screen-history" style="display:none;">
        <div class="history-header">
            <h3>–ò—Å—Ç–æ—Ä–∏—è</h3>
            <select id="sortSelect">
                <option value="desc">–°–Ω–∞—á–∞–ª–∞ –Ω–æ–≤—ã–µ</option>
                <option value="asc">–°–Ω–∞—á–∞–ª–∞ —Å—Ç–∞—Ä—ã–µ</option>
            </select>
        </div>
        <ul class="history" id="historyList"></ul>
    </div>

    <!-- –ù–µ–¥–µ–ª—å–Ω–∞—è –∏—Å—Ç–æ—Ä–∏—è -->
    <div id="screen-weekly" style="display:none;">
        <h3>–ù–µ–¥–µ–ª—å–Ω–∞—è –∏—Å—Ç–æ—Ä–∏—è</h3>
        <ul class="weekly-list" id="weeklyList"></ul>
    </div>

    <!-- –ö–∞—Ç–µ–≥–æ—Ä–∏–∏ -->
    <div id="screen-categories" style="display:none;">
        <h3>–ö–∞—Ç–µ–≥–æ—Ä–∏–∏</h3>
        <button onclick="addCategoryPrompt()">+ –î–æ–±–∞–≤–∏—Ç—å –∫–∞—Ç–µ–≥–æ—Ä–∏—é</button>
        <ul class="category-list" id="categoryList"></ul>
    </div>
</main>

<!-- –ö–ª–∞–≤–∏–∞—Ç—É—Ä–∞ -->
<div class="keyboard-container" id="keyboardContainer">
    <div class="input-row">
        <div class="input-display" id="inputDisplay"></div>
        <div class="confirm-btn" id="confirmBtn">‚úì</div>
    </div>
    <div class="keyboard" id="keyboard"></div>
</div>

<!-- –ù–∞–≤–∏–≥–∞—Ü–∏—è -->
<nav>
    <button id="btn-main" class="active">üè†</button>
    <button id="btn-history">üìú</button>
    <button id="btn-weekly">üìÖ</button>
    <button id="btn-categories">üóÇ</button>
</nav>

<script>
    let db;
    const request = indexedDB.open("productivityDB", 11);
    request.onupgradeneeded = (e) => {
        db = e.target.result;
        if (!db.objectStoreNames.contains("records"))
            db.createObjectStore("records", { keyPath: "id", autoIncrement: true });
        if (!db.objectStoreNames.contains("categories"))
            db.createObjectStore("categories", { keyPath: "id", autoIncrement: true });
        if (!db.objectStoreNames.contains("weekly"))
            db.createObjectStore("weekly", { keyPath: "date" }); // –¥–∞—Ç–∞ –∫–∞–∫ –∫–ª—é—á
        if (!db.objectStoreNames.contains("meta"))
            db.createObjectStore("meta", { keyPath: "key" }); // –¥–ª—è —Ö—Ä–∞–Ω–µ–Ω–∏—è lastDate
    };
    request.onsuccess = (e) => {
        db = e.target.result;
        checkDayChange();
        loadHistory();
        loadCategories();
        updateCounter();
        loadWeekly();
    };

    const counterEl = document.getElementById("counter");
    const keyboardEl = document.getElementById("keyboard");
    const keyboardContainer = document.getElementById("keyboardContainer");
    const historyEl = document.getElementById("historyList");
    const weeklyEl = document.getElementById("weeklyList");
    const categoriesEl = document.getElementById("categories");
    const categoryListEl = document.getElementById("categoryList");
    const inputDisplay = document.getElementById("inputDisplay");
    const confirmBtn = document.getElementById("confirmBtn");
    const progressCircle = document.querySelector(".progress");
    const levelText = document.getElementById("levelText");
    const sortSelect = document.getElementById("sortSelect");

    const circleLength = 2 * Math.PI * 36;
    progressCircle.setAttribute("stroke-dasharray", circleLength);

    let currentCategoryId = null;
    let currentValue = "";
    let sortOrder = localStorage.getItem("historySort") || "desc";
    sortSelect.value = sortOrder;
    sortSelect.onchange = () => {
        sortOrder = sortSelect.value;
        localStorage.setItem("historySort", sortOrder);
        loadHistory();
    };

    // ===== –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å–º–µ–Ω—ã –¥–Ω—è =====
    function checkDayChange() {
        const today = new Date().toISOString().slice(0,10); // yyyy-mm-dd
        const tx = db.transaction("meta", "readwrite");
        const store = tx.objectStore("meta");
        store.get("lastDate").onsuccess = (e) => {
            const rec = e.target.result;
            if (!rec || rec.value !== today) {
                finalizeDay(rec ? rec.value : today);
                store.put({ key: "lastDate", value: today });
            }
        };
    }
    function finalizeDay(date) {
        if (!date) return;
        let sum = 0;
        const tx = db.transaction("records", "readonly");
        tx.objectStore("records").openCursor().onsuccess = (e) => {
            const cursor = e.target.result;
            if (cursor) {
                sum += cursor.value.value;
                cursor.continue();
            } else {
                const level = sum > 0 ? Math.floor(sum/100) : 0;
                const tx2 = db.transaction("weekly", "readwrite");
                tx2.objectStore("weekly").put({ date, sum, level });
                // –æ—á–∏—â–∞–µ–º –∑–∞–ø–∏—Å–∏
                const tx3 = db.transaction("records", "readwrite");
                tx3.objectStore("records").clear().onsuccess = () => {
                    loadHistory();
                    updateCounter();
                    loadWeekly();
                };
            }
        };
    }

    // ===== –ö–∞—Ç–µ–≥–æ—Ä–∏–∏ =====
    function addCategory(name) {
        const tx = db.transaction("categories", "readwrite");
        tx.objectStore("categories").add({ name });
        tx.oncomplete = () => loadCategories();
    }
    function updateCategory(id, newName) {
        const tx = db.transaction("categories", "readwrite");
        const store = tx.objectStore("categories");
        store.get(id).onsuccess = (e) => {
            const cat = e.target.result;
            cat.name = newName;
            store.put(cat);
        };
        tx.oncomplete = () => { loadCategories(); loadHistory(); };
    }
    function deleteCategory(id) {
        const tx = db.transaction("categories", "readwrite");
        tx.objectStore("categories").delete(id);
        tx.oncomplete = () => { loadCategories(); loadHistory(); };
    }
    function loadCategories() {
        categoriesEl.innerHTML = "";
        const addChip = document.createElement("div");
        addChip.className = "chip add";
        addChip.textContent = "+";
        addChip.onclick = addCategoryPrompt;
        categoriesEl.appendChild(addChip);

        categoryListEl.innerHTML = "";
        const tx = db.transaction("categories", "readonly");
        tx.objectStore("categories").openCursor().onsuccess = (e) => {
            const cursor = e.target.result;
            if (cursor) {
                const cat = cursor.value;
                const chip = document.createElement("div");
                chip.className = "chip";
                chip.textContent = cat.name;
                chip.onclick = () => { currentCategoryId = cat.id; showKeyboard(); };
                categoriesEl.appendChild(chip);

                const li = document.createElement("li");
                li.innerHTML = `<span>${cat.name}</span>`;
                const actions = document.createElement("div");
                actions.className = "cat-actions";
                const editBtn = document.createElement("button");
                editBtn.textContent = "‚úé";
                editBtn.onclick = () => {
                    const newName = prompt("–ù–æ–≤–æ–µ –Ω–∞–∑–≤–∞–Ω–∏–µ:", cat.name);
                    if (newName) updateCategory(cat.id, newName);
                };
                const delBtn = document.createElement("button");
                delBtn.textContent = "üóë";
                delBtn.onclick = () => deleteCategory(cat.id);
                actions.appendChild(editBtn);
                actions.appendChild(delBtn);
                li.appendChild(actions);
                categoryListEl.appendChild(li);

                cursor.continue();
            }
        };
    }
    function addCategoryPrompt() {
        const name = prompt("–ù–∞–∑–≤–∞–Ω–∏–µ –∫–∞—Ç–µ–≥–æ—Ä–∏–∏:");
        if (name) addCategory(name);
    }

    // ===== –ö–ª–∞–≤–∏–∞—Ç—É—Ä–∞ =====
    function showKeyboard() {
        keyboardEl.innerHTML = "";
        keyboardContainer.style.display = "block";
        inputDisplay.textContent = "";
        const keys = ["1","2","3","4","5","6","7","8","9","0","-","‚Üê"];
        keys.forEach(k => {
            const btn = document.createElement("div");
            btn.className = "key";
            btn.textContent = k;
            btn.onclick = () => handleKey(k);
            keyboardEl.appendChild(btn);
        });
        currentValue = "";
    }
    function handleKey(k) {
        if (k === "‚Üê") currentValue = currentValue.slice(0,-1);
        else {
            if (k === "-" && currentValue.includes("-")) return;
            currentValue += k;
        }
        inputDisplay.textContent = currentValue;
    }
    confirmBtn.onclick = () => {
        if (currentValue) saveRecord(currentCategoryId, parseInt(currentValue));
        keyboardContainer.style.display = "none";
        inputDisplay.textContent = "";
    };

    // ===== –ó–∞–ø–∏—Å–∏ =====
    function saveRecord(categoryId, value) {
        const tx = db.transaction("records", "readwrite");
        tx.objectStore("records").add({ categoryId, value, date: new Date().toISOString() });
        tx.oncomplete = () => { loadHistory(); updateCounter(); };
    }
    function updateRecord(id, newValue) {
        const tx = db.transaction("records", "readwrite");
        const store = tx.objectStore("records");
        store.get(id).onsuccess = (e) => {
            const rec = e.target.result;
            rec.value = newValue;
            store.put(rec);
        };
        tx.oncomplete = () => { loadHistory(); updateCounter(); };
    }
    function deleteRecord(id) {
        const tx = db.transaction("records", "readwrite");
        tx.objectStore("records").delete(id);
        tx.oncomplete = () => { loadHistory(); updateCounter(); };
    }
    function loadHistory() {
        historyEl.innerHTML = "";
        const records = [];
        const categoriesMap = {};
        const txCats = db.transaction("categories", "readonly");
        txCats.objectStore("categories").openCursor().onsuccess = (e) => {
            const cursor = e.target.result;
            if (cursor) {
                categoriesMap[cursor.value.id] = cursor.value.name;
                cursor.continue();
            }
        };
        txCats.oncomplete = () => {
            const tx = db.transaction("records", "readonly");
            tx.objectStore("records").openCursor().onsuccess = (e) => {
                const cursor = e.target.result;
                if (cursor) {
                    records.push(cursor.value);
                    cursor.continue();
                } else {
                    records.sort((a,b) => {
                        if (sortOrder === "asc") return new Date(a.date) - new Date(b.date);
                        else return new Date(b.date) - new Date(a.date);
                    });
                    records.forEach(rec => {
                        const li = document.createElement("li");
                        const catName = categoriesMap[rec.categoryId] || "‚ùå –£–¥–∞–ª–µ–Ω–æ";
                        const textSpan = document.createElement("span");
                        textSpan.textContent = `${catName}: ${rec.value}`;
                        const actions = document.createElement("div");
                        actions.className = "record-actions";
                        const editBtn = document.createElement("button");
                        editBtn.textContent = "‚úé";
                        editBtn.onclick = () => {
                            const newVal = prompt("–ù–æ–≤–æ–µ –∑–Ω–∞—á–µ–Ω–∏–µ:", rec.value);
                            if (newVal !== null && newVal.trim() !== "" && !isNaN(newVal)) {

                                updateRecord(rec.id, parseInt(newVal));
                            }
                        };
                        const delBtn = document.createElement("button");
                        delBtn.textContent = "üóë";
                        delBtn.onclick = () => deleteRecord(rec.id);

                        actions.appendChild(editBtn);
                        actions.appendChild(delBtn);

                        li.appendChild(textSpan);
                        li.appendChild(actions);
                        historyEl.appendChild(li);
                    });
                }
            };
        };
    }

    // ===== –ù–µ–¥–µ–ª—å–Ω–∞—è –∏—Å—Ç–æ—Ä–∏—è =====
    function loadWeekly() {
        weeklyEl.innerHTML = "";
        const tx = db.transaction("weekly", "readonly");
        tx.objectStore("weekly").openCursor().onsuccess = (e) => {
            const cursor = e.target.result;
            if (cursor) {
                const rec = cursor.value;
                const li = document.createElement("li");
                li.innerHTML = `<span>${rec.date}</span><span>${rec.sum} (lvl ${rec.level})</span>`;
                weeklyEl.appendChild(li);
                cursor.continue();
            }
        };
    }

    // ===== –°—á—ë—Ç—á–∏–∫ =====
    function updateCounter() {
        let sum = 0;
        const tx = db.transaction("records", "readonly");
        tx.objectStore("records").openCursor().onsuccess = (e) => {
            const cursor = e.target.result;
            if (cursor) {
                sum += cursor.value.value;
                cursor.continue();
            } else {
                counterEl.textContent = sum;
                if (sum > 0) counterEl.style.color = "green";
                else if (sum < 0) counterEl.style.color = "red";
                else counterEl.style.color = "black";

                let level = 0, progress = 0;
                if (sum > 0) {
                    level = Math.floor(sum / 100);
                    progress = sum % 100;
                }
                const offset = circleLength - (circleLength * progress / 100);
                progressCircle.setAttribute("stroke-dashoffset", offset);
                levelText.textContent = level;
            }
        };
    }

    // ===== –ù–∞–≤–∏–≥–∞—Ü–∏—è =====
    function showScreen(id) {
        ["screen-main","screen-history","screen-weekly","screen-categories"].forEach(s => {
            document.getElementById(s).style.display = "none";
        });
        document.getElementById(id).style.display = "block";

        document.querySelectorAll("nav button").forEach(b => b.classList.remove("active"));
        if (id === "screen-main") document.getElementById("btn-main").classList.add("active");
        if (id === "screen-history") document.getElementById("btn-history").classList.add("active");
        if (id === "screen-weekly") document.getElementById("btn-weekly").classList.add("active");
        if (id === "screen-categories") document.getElementById("btn-categories").classList.add("active");
    }

    document.getElementById("btn-main").onclick = () => showScreen("screen-main");
    document.getElementById("btn-history").onclick = () => showScreen("screen-history");
    document.getElementById("btn-weekly").onclick = () => showScreen("screen-weekly");
    document.getElementById("btn-categories").onclick = () => showScreen("screen-categories");
</script>
</body>
</html>
