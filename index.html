<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>–°—á—ë—Ç—á–∏–∫</title>
    <style>
        body{font-family:sans-serif;margin:0;display:flex;flex-direction:column;align-items:center;height:100vh}
        #topBar{display:flex;justify-content:space-between;align-items:center;
            width:100%;padding:10px 20px;background:#f0f0f0;font-size:5vw;font-weight:bold}
        #finishBtn{cursor:pointer;font-size:20px;line-height:1;background:none;border:none;padding:0;margin:0;user-select:none}
        #counter{font-size:10vw;margin:20px;text-align:center;word-break:break-word;
            font-weight:bold;font-family:monospace;color:gray}
        .chips{display:inline-block;background:#eee;padding:5px 15px;
            margin:5px;border-radius:20px;cursor:pointer;font-size:5vw;user-select:none}
        #chips{display:flex;flex-wrap:wrap;justify-content:center}
        #historyBox{margin-top:15px;width:90%;max-height:30vh;display:flex;flex-direction:column;border:1px solid #ddd;border-radius:5px}
        #historyHead{display:flex;justify-content:space-between;align-items:center;
            font-size:5vw;padding:5px;flex-shrink:0;background:#f9f9f9;border-bottom:1px solid #ddd}
        #groupBtn{cursor:pointer;font-size:20px;line-height:1;user-select:none}
        #history{flex:1;overflow-y:auto;font-size:4vw}
        .row{display:flex;justify-content:space-between;padding:5px;border-bottom:1px solid #eee}
        #kb{display:none;position:fixed;bottom:0;left:0;width:100%;
            background:#f5f5f5;padding:10px;box-shadow:0 -2px 5px #ccc}
        #kbTop{display:flex;gap:5px;margin-bottom:10px}
        #display{flex:1;padding:10px;font-size:6vw;text-align:right;border:1px solid #ccc;border-radius:5px;background:#fff}
        #del{padding:10px;font-size:6vw}
        .grid{display:grid;grid-template-columns:repeat(3,1fr);gap:5px}
        button{padding:15px;font-size:6vw;width:100%;border:none;border-radius:8px;background:#ddd}
        button:active{background:#bbb}
    </style>
</head>
<body>
<div id="topBar">
    <span id="today"></span>
    <button id="finishBtn" onclick="finishDay()">üèÅ</button>
</div>

<div id="counter">0</div>

<div id="chips">
    <div class="chips" onclick="addCat()">+</div>
</div>

<div id="historyBox">
    <div id="historyHead">
        <span>–ò—Å—Ç–æ—Ä–∏—è</span>
        <span id="groupBtn" onclick="toggleGroup()">üìÇ</span>
    </div>
    <div id="history"></div>
</div>

<div id="kb">
    <div id="kbTop">
        <input id="display" readonly>
        <button id="del" onclick="delChar()">‚Üê</button>
    </div>
    <div class="grid" id="keys"></div>
</div>

<script>
    let db, counter=0, counterEl=document.getElementById("counter"),
        chips=document.getElementById("chips"),
        kb=document.getElementById("kb"), cur=null, buf="", curName="",
        historyEl=document.getElementById("history"),
        grouped=false; // —Ä–µ–∂–∏–º –∏—Å—Ç–æ—Ä–∏–∏

    document.getElementById("today").textContent=new Date().toLocaleDateString("ru-RU");

    // === IndexedDB init ===
    let openReq = indexedDB.open("scoreDB",11);
    openReq.onupgradeneeded=e=>{
        db=e.target.result;
        if(!db.objectStoreNames.contains("data")) db.createObjectStore("data",{keyPath:"id"});
        if(!db.objectStoreNames.contains("cats")) db.createObjectStore("cats",{keyPath:"name"});
        if(!db.objectStoreNames.contains("history")) db.createObjectStore("history",{autoIncrement:true});
        if(!db.objectStoreNames.contains("week")) db.createObjectStore("week",{autoIncrement:true});
    };
    openReq.onsuccess=e=>{
        db=e.target.result;
        loadData();
    };

    // === save & load ===
    function saveCounter(){ tx("data","readwrite").put({id:"counter",value:counter}); }
    function saveCat(name){ tx("cats","readwrite").put({name}); }
    function delCat(name){ tx("cats","readwrite").delete(name); }
    function saveHistory(cat,val){
        tx("history","readwrite").add({cat,val});
        if(!grouped) renderHistory(cat,val);
    }
    function loadData(){
        tx("data").get("counter").onsuccess=e=>{
            if(e.target.result){
                counter=e.target.result.value;
                updateCounter();
            }
        };
        tx("cats").getAll().onsuccess=e=>{
            e.target.result.forEach(r=>renderCat(r.name));
        };
        renderHistoryList();
    }
    function tx(store,mode="readonly"){ return db.transaction(store,mode).objectStore(store); }

    // === –ó–∞–≤–µ—Ä—à–∏—Ç—å –¥–µ–Ω—å ===
    function finishDay(){
        let date=new Date().toLocaleDateString("ru-RU");
        tx("history").getAll().onsuccess=e=>{
            let records=e.target.result;
            tx("week","readwrite").add({date, counter, records});
            counter=0; updateCounter(); saveCounter();
            historyEl.innerHTML="";
            db.transaction("history","readwrite").objectStore("history").clear();
        };
    }

    // === UI ===
    function addCat(){
        let name=prompt("–í–≤–µ–¥–∏—Ç–µ –Ω–∞–∑–≤–∞–Ω–∏–µ –∫–∞—Ç–µ–≥–æ—Ä–∏–∏:");
        if(!name) return;
        renderCat(name);
        saveCat(name);
    }

    function renderCat(name){
        let c=document.createElement("div");
        c.className="chips"; c.textContent=name;
        c.onclick=()=>openKB(c,name);
        c.oncontextmenu=e=>{e.preventDefault();c.remove();delCat(name);}
        chips.appendChild(c);
    }

    function renderHistory(cat,val){
        let row=document.createElement("div");
        row.className="row";
        row.innerHTML=`<span>${cat}</span><span style="color:${val>=0?'green':'red'}">${val}</span>`;
        historyEl.prepend(row);
    }

    function renderHistoryList(){
        historyEl.innerHTML="";
        tx("history").getAll().onsuccess=e=>{
            e.target.result.reverse().forEach(r=>{
                renderHistory(r.cat,r.val);
            });
        };
    }

    function renderGroupedHistory(){
        historyEl.innerHTML="";
        let sums={};
        tx("history").getAll().onsuccess=e=>{
            e.target.result.forEach(r=>{
                sums[r.cat]=(sums[r.cat]||0)+r.val;
            });
            Object.keys(sums).forEach(cat=>{
                let v=sums[cat];
                let row=document.createElement("div");
                row.className="row";
                row.innerHTML=`<span>${cat}</span><span style="color:${v>=0?'green':'red'}">${v}</span>`;
                historyEl.appendChild(row);
            });
        };
    }

    function toggleGroup(){
        grouped=!grouped;
        if(grouped) renderGroupedHistory();
        else renderHistoryList();
    }

    // === Counter Color ===
    function updateCounter(){
        counterEl.textContent=counter;
        if(counter>0) counterEl.style.color="green";
        else if(counter<0) counterEl.style.color="red";
        else counterEl.style.color="gray";
    }

    // === Keyboard ===
    function openKB(c,name){
        cur=c; curName=name; buf="";
        document.getElementById("display").value="";
        kb.style.display="block"; renderKeys();
    }

    function renderKeys(){
        let k=["1","2","3","4","5","6","7","8","9","-","0","OK"];
        let grid=document.getElementById("keys"); grid.innerHTML="";
        k.forEach(val=>{
            let b=document.createElement("button");
            b.textContent=val; b.onclick=()=>press(val);
            grid.appendChild(b);
        });
    }

    function press(k){
        if(k==="OK"){
            if(buf){
                let val=parseInt(buf);
                counter+=val;
                updateCounter();
                cur.textContent=curName;
                saveCounter();
                saveHistory(curName,val);
            }
            buf=""; kb.style.display="none"; return;
        }
        if(k==="-"){
            if(buf.startsWith("-")) buf=buf.slice(1);
            else buf = buf? "-"+buf : "-";
        } else {
            buf+=k;
        }
        document.getElementById("display").value=buf;
        cur.textContent=curName+(buf?": "+buf:"");
    }

    function delChar(){
        buf=buf.slice(0,-1);
        document.getElementById("display").value=buf;
        cur.textContent=curName+(buf?": "+buf:"");
    }
</script>
</body>
</html>
