<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>–ü—Ä–æ–¥—É–∫—Ç–∏–≤–Ω–æ—Å—Ç—å</title>
    <style>
        body {
            font-family: sans-serif;
            margin: 0;
            padding: 0;
            background: #fff;
            color: #222;
            display: flex;
            flex-direction: column;
            height: 100vh;
        }
        main {
            flex: 1;
            overflow-y: auto;
            padding: 12px;
            padding-bottom: 22vh;
        }
        .counter-container {
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 20px;
            margin: 20px 0;
        }
        .counter {
            font-size: 12vw;
            font-weight: bold;
        }
        .level-ring {
            position: relative;
            width: 22vw;
            height: 22vw;
            min-width: 80px;
            min-height: 80px;
        }
        .level-ring svg {
            transform: rotate(-90deg);
            width: 100%;
            height: 100%;
        }
        .level-ring circle {
            fill: none;
            stroke-width: 8;
            r: 36;
            cx: 40;
            cy: 40;
        }
        .level-ring .bg { stroke: #ccc; }
        .level-ring .progress { stroke: #4caf50; }
        .level-text {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%,-50%);
            font-size: 5vw;
            font-weight: bold;
        }
        .chips {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
            justify-content: center;
            margin-bottom: 16px;
        }
        .chip {
            padding: 8px 14px;
            border-radius: 16px;
            background: #eee;
            cursor: pointer;
            font-size: 14px;
        }
        .chip.add {
            background: #4caf50;
            color: white;
            font-weight: bold;
        }
        .keyboard-container {
            position: fixed;
            bottom: 8vh;
            left: 0; right: 0;
            background: #fafafa;
            border-top: 1px solid #ccc;
            padding: 8px;
            display: none;
            z-index: 100;
        }
        .input-row {
            display: flex;
            margin-bottom: 8px;
        }
        .input-display {
            flex: 1;
            background: #fff;
            border: 1px solid #ccc;
            padding: 10px;
            font-size: 18px;
            border-radius: 6px;
            margin-right: 8px;
        }
        .confirm-btn {
            background: #4caf50;
            color: white;
            padding: 10px 16px;
            border-radius: 6px;
            font-size: 18px;
            cursor: pointer;
            border: none;
        }
        .keyboard {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 6px;
        }
        .key {
            background: #fff;
            border: 1px solid #ccc;
            padding: 14px 0;
            font-size: 18px;
            text-align: center;
            border-radius: 6px;
            cursor: pointer;
        }
        .history-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
        }
        .history, .weekly-list, .category-list, .today-list {
            list-style: none;
            padding: 0;
            margin: 0;
        }
        .history li, .weekly-list li, .category-list li, .today-list li {
            background: #f9f9f9;
            border: 1px solid #ddd;
            margin: 6px 0;
            padding: 10px;
            border-radius: 6px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-size: 14px;
        }
        .record-actions button,
        .cat-actions button {
            font-size: 14px;
            margin-left: 6px;
            cursor: pointer;
        }
        nav {
            position: fixed;
            bottom: 0; left: 0; right: 0;
            display: flex;
            border-top: 1px solid #ccc;
            height: 8vh;
            background: #fafafa;
        }
        nav button {
            flex: 1;
            font-size: 20px;
            border: none;
            background: transparent;
            cursor: pointer;
        }
        nav button.active { background: #ddd; }
    </style>
</head>
<body>

<main>
    <!-- –ì–ª–∞–≤–Ω–∞—è -->
    <div id="screen-main">
        <div class="counter-container">
            <div class="counter" id="counter">0</div>
            <div class="level-ring">
                <svg viewBox="0 0 80 80">
                    <circle class="bg" r="36" cx="40" cy="40"></circle>
                    <circle class="progress" r="36" cx="40" cy="40" stroke-dasharray="226" stroke-dashoffset="226"></circle>
                </svg>
                <div class="level-text" id="levelText">0</div>
            </div>
        </div>
        <div class="chips" id="categories">
            <div class="chip add" onclick="addCategoryPrompt()">+</div>
        </div>
    </div>

    <!-- –ò—Å—Ç–æ—Ä–∏—è -->
    <div id="screen-history" style="display:none;">
        <div class="history-header">
            <h3>–ò—Å—Ç–æ—Ä–∏—è</h3>
            <select id="sortSelect">
                <option value="desc">–°–Ω–∞—á–∞–ª–∞ –Ω–æ–≤—ã–µ</option>
                <option value="asc">–°–Ω–∞—á–∞–ª–∞ —Å—Ç–∞—Ä—ã–µ</option>
            </select>
        </div>
        <ul class="history" id="historyList"></ul>
    </div>

    <!-- –°–µ–≥–æ–¥–Ω—è—à–Ω—è—è —Å–≤–æ–¥–∫–∞ -->
    <div id="screen-today" style="display:none;">
        <h3>–°–µ–≥–æ–¥–Ω—è</h3>
        <ul class="today-list" id="todayList"></ul>
    </div>

    <!-- –ù–µ–¥–µ–ª—å–Ω–∞—è –∏—Å—Ç–æ—Ä–∏—è -->
    <div id="screen-weekly" style="display:none;">
        <h3>–ù–µ–¥–µ–ª—å–Ω–∞—è –∏—Å—Ç–æ—Ä–∏—è</h3>
        <ul class="weekly-list" id="weeklyList"></ul>
    </div>

    <!-- –ö–∞—Ç–µ–≥–æ—Ä–∏–∏ -->
    <div id="screen-categories" style="display:none;">
        <h3>–ö–∞—Ç–µ–≥–æ—Ä–∏–∏</h3>
        <button onclick="addCategoryPrompt()">+ –î–æ–±–∞–≤–∏—Ç—å –∫–∞—Ç–µ–≥–æ—Ä–∏—é</button>
        <ul class="category-list" id="categoryList"></ul>
    </div>
</main>

<!-- –ö–ª–∞–≤–∏–∞—Ç—É—Ä–∞ -->
<div class="keyboard-container" id="keyboardContainer">
    <div class="input-row">
        <div class="input-display" id="inputDisplay"></div>
        <button class="confirm-btn" id="confirmBtn">‚úì</button>
    </div>
    <div class="keyboard" id="keyboard"></div>
</div>

<!-- –ù–∞–≤–∏–≥–∞—Ü–∏—è -->
<nav>
    <button id="btn-main" class="active">üè†</button>
    <button id="btn-history">üìú</button>
    <button id="btn-today">üìä</button>
    <button id="btn-weekly">üìÖ</button>
    <button id="btn-categories">üóÇ</button>
</nav>

<script>
    let db;
    const request = indexedDB.open("productivityDB", 13);
    request.onupgradeneeded = (e) => {
        db = e.target.result;
        if (!db.objectStoreNames.contains("records"))
            db.createObjectStore("records", { keyPath: "id", autoIncrement: true });
        if (!db.objectStoreNames.contains("categories"))
            db.createObjectStore("categories", { keyPath: "id", autoIncrement: true });
        if (!db.objectStoreNames.contains("weekly"))
            db.createObjectStore("weekly", { keyPath: "date" });
        if (!db.objectStoreNames.contains("meta"))
            db.createObjectStore("meta", { keyPath: "key" });
    };
    request.onsuccess = (e) => {
        db = e.target.result;
        loadToday();
    };

    // ===== –°–µ–≥–æ–¥–Ω—è—à–Ω—è—è —Å–≤–æ–¥–∫–∞ =====
    function loadToday() {
        const today = new Date().toISOString().slice(0,10);
        const sums = {};
        const categoriesMap = {};

        const txCats = db.transaction("categories", "readonly");
        txCats.objectStore("categories").openCursor().onsuccess = (e) => {
            const cursor = e.target.result;
            if (cursor) {
                categoriesMap[cursor.value.id] = cursor.value.name;
                cursor.continue();
            }
        };
        txCats.oncomplete = () => {
            const tx = db.transaction("records", "readonly");
            tx.objectStore("records").openCursor().onsuccess = (e) => {
                const cursor = e.target.result;
                if (cursor) {
                    const rec = cursor.value;
                    if (rec.date.startsWith(today)) {
                        sums[rec.categoryId] = (sums[rec.categoryId] || 0) + rec.value;
                    }
                    cursor.continue();
                } else {
                    const todayEl = document.getElementById("todayList");
                    todayEl.innerHTML = "";
                    for (let id in sums) {
                        const li = document.createElement("li");
                        const catName = categoriesMap[id] || "‚ùå –£–¥–∞–ª–µ–Ω–æ";
                        li.textContent = `${catName}: ${sums[id]}`;
                        todayEl.appendChild(li);
                    }
                }
            };
        };
    }

    // ===== –ù–∞–≤–∏–≥–∞—Ü–∏—è =====
    function showScreen(id) {
        ["screen-main","screen-history","screen-today","screen-weekly","screen-categories"].forEach(s => {
            document.getElementById(s).style.display = "none";
        });
        document.getElementById(id).style.display = "block";
        document.querySelectorAll("nav button").forEach(b => b.classList.remove("active"));
        if (id === "screen-main") document.getElementById("btn-main").classList.add("active");
        if (id === "screen-history") document.getElementById("btn-history").classList.add("active");
        if (id === "screen-today") document.getElementById("btn-today").classList.add("active");
        if (id === "screen-weekly") document.getElementById("btn-weekly").classList.add("active");
        if (id === "screen-categories") document.getElementById("btn-categories").classList.add("active");
    }
    document.getElementById("btn-main").onclick = () => showScreen("screen-main");
    document.getElementById("btn-history").onclick = () => { showScreen("screen-history"); };
    document.getElementById("btn-today").onclick = () => { showScreen("screen-today"); loadToday(); };
    document.getElementById("btn-weekly").onclick = () => showScreen("screen-weekly");
    document.getElementById("btn-categories").onclick = () => showScreen("screen-categories");
</script>
</body>
</html>
